#!/bin/bash

# BASH_CLEANUP {{{
BASH_CLEANUP_FILE=`mktemp`
trap BASH_CLEANUP EXIT

function BASH_CLEANUP() {
  BASH_CLEANUP_FILE_REV=`mktemp`
  tac $BASH_CLEANUP_FILE > $BASH_CLEANUP_FILE_REV
  . $BASH_CLEANUP_FILE_REV
  rm $BASH_CLEANUP_FILE $BASH_CLEANUP_FILE_REV
}

function BASH_FINALLY() {
  echo "$*" >> $BASH_CLEANUP_FILE
}

function BASH_MKTEMP() {
  BASH_TMP=`mktemp`
  echo "rm $BASH_TMP" >> $BASH_CLEANUP_FILE
  echo $BASH_TMP
}

function BASH_MKTEMP_DIR() {
  BASH_TMP=`mktemp -d`
  echo "rm -fr $BASH_TMP" >> $BASH_CLEANUP_FILE
  echo $BASH_TMP
}
# }}}

INPUT=$1
OUTPUT=$2

if [[ -z "${VIRTUAL_ENV}" ]];
then
    . init_venv.sh
fi

. venv/bin/activate

save_directives=`BASH_MKTEMP`
temp_output=`BASH_MKTEMP`
sed -n -e "/#.*/p" $INPUT > $save_directives
PYTHONPATH=`pwd`:${PYTHONPATH} python3 ./src/precompiler.py $INPUT $temp_output
cat $save_directives $temp_output > $OUTPUT
clang-format -i $OUTPUT
